name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            bundles: nsis,msi
            extra_args: ""
          - os: macos-13
            bundles: dmg,app
            extra_args: --target x86_64-apple-darwin
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.19.0
          cache: npm
          cache-dependency-path: app/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node deps (app)
        working-directory: app
        shell: bash
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build with Tauri (no release)
        if: github.event_name == 'workflow_dispatch'
        uses: tauri-apps/tauri-action@v0
        with:
          projectPath: app
          args: --bundles ${{ matrix.bundles }} ${{ matrix.extra_args }}

      - name: Build and release with Tauri
        if: startsWith(github.ref, 'refs/tags/v')
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: app
          tagName: v__VERSION__
          releaseName: Free FPS v__VERSION__
          releaseBody: |
            Downloads:
            - Windows portable: `free-fps.exe`
            - Windows installer \(NSIS\): `Free.FPS_x64-setup_windows.exe`
            - Windows installer \(MSI\): `Free.FPS_x64_en-US_windows.msi`
            - macOS Intel: `Free.FPS_x64_darwin.dmg`
          releaseDraft: false
          prerelease: false
          args: --bundles ${{ matrix.bundles }} ${{ matrix.extra_args }}

      - name: Attach portable exe (Windows)
        if: matrix.os == 'windows-latest' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: app/src-tauri/target/release/*.exe
          tag_name: ${{ github.ref_name }}
          fail_on_unmatched_files: true

      - name: Upload MSI as workflow artifact (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: msi-windows
          path: app/src-tauri/target/release/bundle/msi/*.msi
          if-no-files-found: error
          retention-days: 1

  upload-msi-to-azure:
    name: Upload MSI to Azure
    needs: build-and-release
    runs-on: ubuntu-latest
    steps:
      - name: Download MSI artifact
        uses: actions/download-artifact@v4
        with:
          name: msi-windows
          path: ./msi

      - name: Upload MSI to Azure Blob Storage (overwrite)
        uses: azure/cli@v2
        env:
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
          AZURE_CONTAINER_NAME: ${{ secrets.AZURE_CONTAINER_NAME }}
        with:
          inlineScript: |
            MSI_FILE=$(ls ./msi/*.msi | head -n 1)
            echo "Uploading $MSI_FILE to container '$AZURE_CONTAINER_NAME' as 'Free.FPS_x64_en-US_windows-del.msi'"
            az storage blob upload \
              --overwrite true \
              --account-name "$AZURE_STORAGE_ACCOUNT" \
              --account-key "$AZURE_STORAGE_KEY" \
              --container-name "$AZURE_CONTAINER_NAME" \
              --file "$MSI_FILE" \
              --name "Free.FPS_x64_en-US_windows.msi"
